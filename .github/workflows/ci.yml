name: CI

on:
  push:
    branches: [main, "jimmy/*"]
  pull_request:
    branches: [main, jimmy/nssa-framework-migration]

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Generate + Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "ci"

      - name: Install logos-blockchain-circuits
        run: |
          curl -sSL https://raw.githubusercontent.com/logos-blockchain/logos-blockchain/main/scripts/setup-logos-blockchain-circuits.sh | bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install lez-client-gen
        run: |
          cargo install \
            --git https://github.com/jimmy-claw/lez-framework.git \
            --branch main \
            lez-client-gen \
            --locked

      - name: Generate IDL from Rust annotations
        run: |
          cargo run -p lez-multisig-idl-gen > lez-multisig-ffi/src/multisig_idl.json
          echo "IDL generated:" && python3 -m json.tool lez-multisig-ffi/src/multisig_idl.json > /dev/null && echo "✅ valid JSON"

      - name: Generate FFI client from IDL
        run: |
          mkdir -p /tmp/lez-ffi-gen
          lez-client-gen --idl lez-multisig-ffi/src/multisig_idl.json --out-dir /tmp/lez-ffi-gen
          echo '// GENERATED FILE — do not edit manually. Run make generate to regenerate.' > lez-multisig-ffi/src/multisig.rs
          cat /tmp/lez-ffi-gen/multisig_program_ffi.rs >> lez-multisig-ffi/src/multisig.rs
          echo "✅ FFI client generated"

      - name: Run unit tests
        env:
          RISC0_SKIP_BUILD: "1"
        run: cargo test -p multisig_core -p multisig_program

      - name: cargo check (all crates)
        env:
          RISC0_SKIP_BUILD: "1"
        run: cargo check --workspace --exclude multisig-guest

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-${{ github.sha }}
          path: |
            lez-multisig-ffi/src/multisig_idl.json
            lez-multisig-ffi/src/multisig.rs
          retention-days: 30
