name: Check & Generate

on:
  push:
    branches: [main, "jimmy/*"]
  pull_request:
    branches: [main, jimmy/nssa-framework-migration]

env:
  CARGO_TERM_COLOR: always
jobs:
  generate-and-check:
    name: Generate IDL + FFI, cargo check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install risc0 toolchain
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt: installing rzup..."
            if curl -L --retry 3 --retry-delay 5 https://risczero.com/install | bash; then
              break
            fi
            echo "rzup install script failed, retrying in 10s..."
            sleep 10
          done
          echo "$HOME/.risc0/bin" >> $GITHUB_PATH
          export PATH="$HOME/.risc0/bin:$PATH"
          rzup install cargo-risczero ${{ env.RISC0_VERSION }}
          rzup install r0vm ${{ env.RISC0_VERSION }}
          rzup install rust

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "generate"

      - name: Install logos-blockchain-circuits
        run: |
          curl -sSL https://raw.githubusercontent.com/logos-blockchain/logos-blockchain/main/scripts/setup-logos-blockchain-circuits.sh | bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install lez-client-gen
        run: |
          cargo install \
            --git https://github.com/jimmy-claw/lez-framework.git \
            --branch main \
            lez-client-gen \
            --locked

      - name: Generate IDL from Rust annotations
        run: |
          cargo run --manifest-path methods/guest/Cargo.toml --bin generate_idl \
            > lez-multisig-ffi/src/multisig_idl.json
          echo "✅ IDL generated"
          cat lez-multisig-ffi/src/multisig_idl.json | python3 -m json.tool --no-ensure-ascii > /dev/null \
            && echo "✅ IDL is valid JSON"

      - name: Generate FFI client from IDL
        run: |
          mkdir -p /tmp/lez-ffi-gen
          lez-client-gen \
            --idl lez-multisig-ffi/src/multisig_idl.json \
            --out-dir /tmp/lez-ffi-gen
          cp /tmp/lez-ffi-gen/multisig_program_ffi.rs lez-multisig-ffi/src/multisig.rs
          echo "✅ FFI client generated"
          head -3 lez-multisig-ffi/src/multisig.rs

      - name: cargo check (all crates)
        run: cargo check --workspace --exclude multisig-guest

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-${{ github.sha }}
          path: |
            lez-multisig-ffi/src/multisig_idl.json
            lez-multisig-ffi/src/multisig.rs
          retention-days: 30
