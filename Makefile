# Multisig Program â€” Quick Commands
#
# Prerequisites:
#   - Rust + risc0 toolchain installed
#   - wallet CLI installed (`cargo install --path wallet` from lssa repo)
#   - Sequencer running locally
#   - wallet setup done (`wallet setup`)
#
# Quick start:
#   make build deploy
#   multisig create --threshold 2 --member <ID1> --member <ID2> --member <ID3>
#
# State is saved in .multisig-state so you don't have to re-enter IDs.

SHELL := /bin/bash
STATE_FILE := .multisig-state
PROGRAMS_DIR := target/riscv32im-risc0-zkvm-elf/docker

# Token program binary â€” set this to point to your lssa build
# e.g. LSSA_DIR=../lssa
LSSA_DIR ?= $(error Set LSSA_DIR to your lssa repo root, e.g. make build LSSA_DIR=../lssa)
TOKEN_BIN := $(LSSA_DIR)/artifacts/program_methods/token.bin

MULTISIG_BIN := $(PROGRAMS_DIR)/multisig.bin

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

-include $(STATE_FILE)

define save_var
	@grep -v '^$(1)=' $(STATE_FILE) 2>/dev/null > $(STATE_FILE).tmp || true
	@echo '$(1)=$(2)' >> $(STATE_FILE).tmp
	@mv $(STATE_FILE).tmp $(STATE_FILE)
endef

define require_state
	@if [ -z "$($(1))" ]; then echo "ERROR: $(1) not set. Run the required step first or set it manually."; exit 1; fi
endef

# â”€â”€ Targets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€ Code Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# The IDL and FFI client are generated files â€” do not edit them manually.
# Source of truth: multisig_program/src/lib.rs (Rust macro annotations)
# Pipeline: lib.rs â†’ multisig_idl.json â†’ multisig.rs

LEZ_FW_GIT  := https://github.com/jimmy-claw/lez-framework.git
LEZ_FW_BRANCH := main
IDL_JSON    := lez-multisig-ffi/src/multisig_idl.json
FFI_RS      := lez-multisig-ffi/src/multisig.rs
GENERATE_IDL_BIN := methods/guest/Cargo.toml

.PHONY: generate generate-idl generate-ffi check-generated install-tools

install-tools: ## Install lez-client-gen from lez-framework (required for generate-ffi)
	source ~/.cargo/env && cargo install --git $(LEZ_FW_GIT) --branch $(LEZ_FW_BRANCH) lez-client-gen --locked 2>/dev/null || \
	cargo install --git $(LEZ_FW_GIT) --branch $(LEZ_FW_BRANCH) lez-client-gen

generate-idl: ## Regenerate IDL from Rust annotations in lib.rs
	@echo "ðŸ”¨ Generating IDL from multisig_program/src/lib.rs..."
	source ~/.cargo/env && cargo run -p lez-multisig-idl-gen > $(IDL_JSON)
	@echo "âœ… IDL written to $(IDL_JSON)"

generate-ffi: ## Regenerate FFI client (multisig.rs) from IDL
	@echo "ðŸ”¨ Generating FFI client from $(IDL_JSON)..."
	@mkdir -p /tmp/lez-ffi-gen
	source ~/.cargo/env && lez-client-gen --idl $(IDL_JSON) --out-dir /tmp/lez-ffi-gen || \
		(echo "ERROR: lez-client-gen not found. Run: make install-tools" && exit 1)
	@# Prepend generated-file header, then append lez-client-gen output
	@echo "// GENERATED FILE â€” do not edit manually. Run 'make generate' to regenerate from Rust annotations." > $(FFI_RS)
	@cat /tmp/lez-ffi-gen/multisig_program_ffi.rs >> $(FFI_RS)
	@echo "âœ… FFI client written to $(FFI_RS)"

generate: ## Regenerate IDL and FFI client from Rust annotations (run after changing lib.rs)
	@echo "ðŸ”„ Regenerating all generated files..."
	$(MAKE) generate-idl
	$(MAKE) generate-ffi
	@echo ""
	@echo "âœ… Generation complete. Run 'cargo check' to verify."

check-generated: ## CI: regenerate and check for drift vs committed state
	@echo "ðŸ” Checking for generated file drift..."
	@$(MAKE) generate > /tmp/generate-output.txt 2>&1 || (cat /tmp/generate-output.txt && exit 1)
	@echo "âœ… Generation succeeded"


.PHONY: help build build-cli deploy status clean test

help: ## Show this help
	@echo "Multisig Program â€” Make Targets"
	@echo ""
	@echo "  Code Generation (start here after changing lib.rs):"
	@echo "  make install-tools         Install lez-client-gen tool (first-time setup)"
	@echo "  make generate              Regen IDL + FFI client from lib.rs annotations"
	@echo "  make generate-idl          Regen IDL only"
	@echo "  make generate-ffi          Regen FFI client only (requires IDL)"
	@echo "  make check-generated       CI: regenerate and verify no drift"
	@echo ""
	@echo "  Build & Deploy:"
	@echo "  make build                 Build the guest binary (needs risc0 toolchain)"
	@echo "  make build-cli             Build the standalone multisig CLI"
	@echo "  make deploy                Deploy multisig + token programs to sequencer"
	@echo "  make test                  Run unit tests"
	@echo "  make status                Show saved state (account IDs, etc.)"
	@echo "  make clean                 Remove saved state"
	@echo ""
	@echo "Required env: LSSA_DIR=<path to lssa repo>"

build: ## Build the multisig guest binary
	cargo risczero build --manifest-path methods/guest/Cargo.toml
	@echo ""
	@echo "âœ… Guest binary built: $(MULTISIG_BIN)"
	@ls -la $(MULTISIG_BIN)

build-cli: ## Build the standalone multisig CLI
	cargo build --bin multisig -p multisig-cli
	@echo ""
	@echo "âœ… CLI built: target/debug/multisig"

deploy: ## Deploy multisig and token programs to sequencer
	@test -f "$(MULTISIG_BIN)" || (echo "ERROR: Multisig binary not found. Run 'make build' first."; exit 1)
	@test -f "$(TOKEN_BIN)" || (echo "ERROR: Token binary not found at $(TOKEN_BIN). Set LSSA_DIR correctly."; exit 1)
	wallet deploy-program $(MULTISIG_BIN)
	wallet deploy-program $(TOKEN_BIN)
	@echo ""
	@echo "âœ… Programs deployed"

test: ## Run unit tests
	cargo test -p multisig_program

status: ## Show saved state
	@echo "Multisig State (from $(STATE_FILE)):"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@if [ -f "$(STATE_FILE)" ]; then cat $(STATE_FILE); else echo "(no state saved)"; fi
	@echo ""
	@echo "Binaries:"
	@ls -la $(MULTISIG_BIN) 2>/dev/null || echo "  multisig.bin: NOT BUILT (run 'make build')"
	@ls -la $(TOKEN_BIN) 2>/dev/null || echo "  token.bin: NOT FOUND (check LSSA_DIR)"

clean: ## Remove saved state
	rm -f $(STATE_FILE) $(STATE_FILE).tmp
	@echo "âœ… State cleaned"
